{% extends 'm.html' %}
{% load static %}
{% block content %}

<style>
  .dashboard-search-bar {
    max-width: 900px;
    margin: 2rem auto 1.5rem auto;
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 2rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    padding: 0.5rem 1rem;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .dashboard-summary-cards .card,
  .dashboard-mini-cards .card {
    border-radius: 1rem;
    transition: transform 0.15s;
  }
  .dashboard-summary-cards .card:hover,
  .dashboard-mini-cards .card:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 4px 24px rgba(0,0,0,0.10);
  }
  .dashboard-summary-cards .icon,
  .dashboard-mini-cards .icon {
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
    display: block;
  }
  .dashboard-mini-cards .card {
    min-width: 180px;
    margin: 0.5rem;
    display: inline-block;
    vertical-align: top;
  }
</style>

<div class="container-xxl flex-grow-1 container-p-y">

  <!-- Month Filter Bar -->
  <form method="get" action="{% url 'payment_summary' %}" class="dashboard-search-bar">
    <input 
      type="month" 
      name="month" 
      value="{{ selected_month|default:'' }}" 
      class="form-control" 
      style="flex:1; min-width:160px;"
    >
    <button type="submit" class="btn btn-primary">Apply</button>
    {% if selected_month %}
      <a href="{% url 'payment_summary' %}" class="btn btn-secondary" style="white-space:nowrap;">Clear</a>
    {% endif %}
  </form>

  <!-- Total Collected Card -->
  <div class="row dashboard-summary-cards mb-4 text-center">
    <div class="col-md-4 offset-md-4 mb-3">
      <div class="card shadow-sm bg-success text-white">
        <div class="card-body">
          <span class="icon"><i class="fas fa-wallet"></i></span>
          <h5>Total Collected</h5>
          <p class="fs-4 mb-0">₹{{ total_payment_collected|floatformat:2 }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini Cards for Payment Methods/Modes (as before) -->
  <!-- ... (keep your mini cards code) ... -->

  <!-- Toggle Button -->
  <div class="text-end mb-3">
    <button id="toggle-view-btn" class="btn btn-outline-primary">
      Show Monthly Expenses
    </button>
  </div>

  <!-- Payment Table Filters -->
  <form method="get" action="{% url 'payment_summary' %}" class="dashboard-search-bar" style="margin-bottom:1rem;" id="payments-filter-bar">
    <input type="hidden" name="month" value="{{ selected_month|default:'' }}">
    <select name="payment_method" class="form-select" style="flex:1; min-width:160px;">
      <option value="">All Methods</option>
      {% for method in payment_methods %}
        <option value="{{ method.enrollment__payment_method }}" {% if method.enrollment__payment_method == pay_method %}selected{% endif %}>{{ method.enrollment__payment_method|capfirst }}</option>
      {% endfor %}
    </select>
    <select name="payment_mode" class="form-select" style="flex:1; min-width:160px;">
      <option value="">All Modes</option>
      {% for mode in payment_modes %}
        <option value="{{ mode.payment_mode }}" {% if mode.payment_mode == pay_mode %}selected{% endif %}>{{ mode.payment_mode|capfirst }}</option>
      {% endfor %}
    </select>
    <input 
      type="text" 
      name="search" 
      placeholder="Search student, course, payment mode..." 
      value="{{ pay_search|default:'' }}" 
      class="form-control" 
      style="flex:2; min-width:200px;"
      autocomplete="off"
    >
    <button type="submit" class="btn btn-primary">Filter</button>
    {% if pay_search or pay_method or pay_mode %}
      <a href="{% url 'payment_summary' %}?month={{ selected_month|default:'' }}" class="btn btn-secondary" style="white-space:nowrap;">Clear</a>
    {% endif %}
  </form>

  <!-- Payment Transactions Table -->
  <div id="payments-table-section">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white text-center">
        <h4 class="mb-0">Payment Transactions{% if selected_month %} ({{ selected_month }}){% endif %}</h4>
      </div>
      <div class="table-responsive">
        <table class="table dashboard-table table-bordered mb-0">
          <thead class="table-light">
            <tr>
              <th>SR No.</th>
              <th>Registration No.</th>
              <th>Student</th>
              <th>Enrollment No.</th>
              <th>Course</th>
              <th>Payment Date</th>
              <th>Amount Paid</th>
              <th>Payment Mode</th>
              <th>Status</th>
              <th>Receipt</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                {{ payment.enrollment.student.student_id|default:"-" }}
              </td>
              <td>{{ payment.enrollment.student.full_name }}</td>
              <td>{{ payment.enrollment.enrollment_id|default:payment.enrollment.id }}</td>
              <td>{{ payment.enrollment.course.course_name }}</td>
              <td>{{ payment.payment_date|date:"d-m-Y" }}</td>
              <td>₹{{ payment.amount_paid|floatformat:2 }}</td>
              <td>{{ payment.get_payment_mode_display }}</td>
              <td>
                {% if payment.payment_status == "paid" %}
                  <span class="badge bg-success">Paid</span>
                {% elif payment.payment_status == "partial" %}
                  <span class="badge bg-info text-white">Partial</span>
                {% elif payment.payment_status == "due" %}
                  <span class="badge bg-warning text-dark">Due</span>
                {% else %}
                  <span class="badge bg-secondary">{{ payment.payment_status|capfirst }}</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'download_payment_receipt' payment.id %}" class="btn btn-success btn-sm" title="Download Payment Receipt">
                  <i class="fas fa-download"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="10" class="text-center text-danger py-4">
                <i class="fas fa-exclamation-circle fa-2x mb-2"></i><br>
                No payment records found for this month.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div> 

  <!-- Expenses Table (hidden by default) -->
  <div id="expenses-table-section" style="display:none;">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-danger text-white text-center">
        <h4 class="mb-0">Monthly Expenses{% if selected_month %} ({{ selected_month }}){% endif %}</h4>
      </div>
      <div class="table-responsive">
        <table class="table dashboard-table table-bordered mb-0">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Expense Name</th>
              <th>Expense By</th>
              <th>Amount</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody>
            {% for expense in expenses %}
            <tr>
              <td>{{ expense.date|date:"d-m-Y" }}</td>
              <td>{{ expense.expense_name }}</td>
              <td>{{ expense.expense_by.name }}</td>
              <td>₹{{ expense.amount|floatformat:2 }}</td>
              <td>{{ expense.remarks }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-danger py-4">
                <i class="fas fa-exclamation-circle fa-2x mb-2"></i><br>
                No expenses recorded for this month.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
   

<script>
  const toggleBtn = document.getElementById('toggle-view-btn');
  const paymentsSection = document.getElementById('payments-table-section');
  const paymentsFilterBar = document.getElementById('payments-filter-bar');
  const expensesSection = document.getElementById('expenses-table-section');
  let showingPayments = true;

  toggleBtn.addEventListener('click', function() {
    showingPayments = !showingPayments;
    if (showingPayments) {
      paymentsSection.style.display = '';
      paymentsFilterBar.style.display = '';
      expensesSection.style.display = 'none';
      toggleBtn.textContent = 'Show Monthly Expenses';
    } else {
      paymentsSection.style.display = 'none';
      paymentsFilterBar.style.display = 'none';
      expensesSection.style.display = '';
      toggleBtn.textContent = 'Show Monthly Payments';
    }
  });
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

{% endblock %}
